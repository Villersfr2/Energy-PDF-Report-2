# ===========================================
# üì¶ EcoPilot PDF Report ‚Äì UI helpers
# ===========================================

input_select:
  pdf_report_period:
    name: P√©riode du rapport
    options: [day, week, month]
    initial: day
    icon: mdi:calendar-range

  pdf_report_language:
    name: Langue du rapport
    options: [fr, en, nl]
    initial: fr
    icon: mdi:translate

input_boolean:
  # Options de contenu
  pdf_report_co2:
    name: Inclure CO‚ÇÇ
    initial: true
    icon: mdi:molecule-co2
  pdf_report_price:
    name: Inclure les prix
    initial: true
    icon: mdi:cash

  # P√©riode de base personnalis√©e (dates)
  pdf_report_custom_range:
    name: Utiliser une p√©riode personnalis√©e
    initial: true
    icon: mdi:calendar-edit

  # Comparaison
  pdf_report_compare:
    name: Activer la comparaison
    initial: false
    icon: mdi:compare
    

  pdf_report_generating:
    name: G√©n√©ration en cours
    initial: false
    icon: mdi:progress-clock

input_text:
  last_pdf_report_title:
    name: Titre du dernier rapport PDF
    max: 255

  last_pdf_report_message:
    name: Message du dernier rapport PDF
    max: 255


input_datetime:
  # P√©riode de base
  pdf_report_start:
    name: Date d√©but (p√©riode de base)
    has_date: true
    has_time: false
    icon: mdi:calendar-start
  pdf_report_end:
    name: Date fin (p√©riode de base)
    has_date: true
    has_time: false
    icon: mdi:calendar-end

  # P√©riode de comparaison
  pdf_report_compare_start:
    name: Date d√©but comparaison
    has_date: true
    has_time: false
    icon: mdi:calendar-start
  pdf_report_compare_end:
    name: Date fin comparaison
    has_date: true
    has_time: false
    icon: mdi:calendar-end
  pdf_report_last_generated:
    name: Dernier rapport g√©n√©r√©
    has_date: true
    has_time: true
    

# -------------------------------------------
# Script (utilis√© par la carte) pour templater
# -------------------------------------------
script:
  pdf_report_generate:
    alias: G√©n√©rer le rapport EcoPilot PDF
    mode: single
    sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.pdf_report_generating

      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.pdf_report_compare
                state: 'on'
            sequence:
              - service: energy_pdf_report.generate
                data:
                  period: "{{ states('input_select.pdf_report_period') }}"
                  language: "{{ states('input_select.pdf_report_language') }}"
                  co2_enabled: "{{ is_state('input_boolean.pdf_report_co2','on') }}"
                  price_enabled: "{{ is_state('input_boolean.pdf_report_price','on') }}"
                  start_date: >
                    {% if is_state('input_boolean.pdf_report_custom_range','on') %}
                      {{ states('input_datetime.pdf_report_start') }}
                    {% else %}
                      {{ '' }}
                    {% endif %}
                  end_date: >
                    {% if is_state('input_boolean.pdf_report_custom_range','on') %}
                      {{ states('input_datetime.pdf_report_end') }}
                    {% else %}
                      {{ '' }}
                    {% endif %}
                  compare: true
                  compare_start_date: "{{ states('input_datetime.pdf_report_compare_start') }}"
                  compare_end_date: "{{ states('input_datetime.pdf_report_compare_end') }}"
        default:
          - service: energy_pdf_report.generate
            data:
              period: "{{ states('input_select.pdf_report_period') }}"
              language: "{{ states('input_select.pdf_report_language') }}"
              co2_enabled: "{{ is_state('input_boolean.pdf_report_co2','on') }}"
              price_enabled: "{{ is_state('input_boolean.pdf_report_price','on') }}"
              start_date: >
                {% if is_state('input_boolean.pdf_report_custom_range','on') %}
                  {{ states('input_datetime.pdf_report_start') }}
                {% else %}
                  {{ '' }}
                {% endif %}
              end_date: >
                {% if is_state('input_boolean.pdf_report_custom_range','on') %}
                  {{ states('input_datetime.pdf_report_end') }}
                {% else %}
                  {{ '' }}
                {% endif %}
              compare: false

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.pdf_report_last_generated
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

automation:
  - id: stop_pdf_generation_indicator
    alias: ‚èπÔ∏è Arr√™ter l'indicateur de g√©n√©ration PDF quand la notification arrive
    description: √âteint le bool√©en de g√©n√©ration d√®s que le rapport PDF est pr√™t
    mode: single
    trigger:
      - platform: persistent_notification
        update_type:
          - added
          - updated
        notification_id: energy_pdf_report_last_report
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.pdf_report_generating

# ‚ö° Automation : capture la notification PDF et stocke le contenu

  - alias: üìÑ Notification - Rapport PDF g√©n√©r√©
    description: Envoie une notification √† la carte Markdown d√®s qu'un rapport PDF est pr√™t
    mode: single
    trigger:
      - platform: persistent_notification
        update_type:
          - added
          - updated
        notification_id: energy_pdf_report_last_report
    action:
      - service: enhanced_input.create_input_text
        data:
          name: pdf_report_last
          title: "{{ trigger.notification.title | default('Rapport √©nergie') }}"
          text: "{{ trigger.notification.message | default('') }}"
